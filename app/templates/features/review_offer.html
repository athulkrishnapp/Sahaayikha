{% extends "base.html" %}
{% block content %}
<style>
    :root {
        --card-bg: var(--bs-body-bg);
        --border-color: var(--bs-border-color);
        --subtle-bg: var(--bs-tertiary-bg);
    }
    .dark-mode {
        --card-bg: #2c2c3a;
        --border-color: rgba(255, 255, 255, 0.1);
        --subtle-bg: rgba(255, 255, 255, 0.05);
    }
    .page-header {
        margin-bottom: 2.5rem;
    }
    .page-header h1 {
        font-weight: 800;
    }
    .main-content .card {
        border: none;
        border-radius: 0.75rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        background-color: var(--card-bg);
    }
    .dark-mode .main-content .card {
        box-shadow: none;
        border: 1px solid var(--border-color);
    }
    .item-card {
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        overflow: hidden;
    }
    .item-image {
        max-height: 250px;
        width: 100%;
        object-fit: cover;
        cursor: pointer;
        transition: opacity 0.2s ease;
    }
    .item-image:hover {
        opacity: 0.8;
    }
    .decision-switch .form-check-input {
        width: 3em;
        height: 1.5em;
    }

    /* ## NEW: Added styles for proof card ## */
    .proof-card img {
        max-height: 400px;
        width: 100%;
        object-fit: cover;
        border-radius: 0.5rem;
        cursor: pointer; 
    }
    .dark-mode .proof-card img {
        border: 1px solid var(--border-color);
    }


    /* --- Image Lightbox Styles --- */
    .lightbox-overlay {
        position: fixed;
        z-index: 1070;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(8px);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .lightbox-overlay.visible {
        display: flex;
        opacity: 1;
    }
    .lightbox-content-wrapper {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
    }
    .lightbox-content {
        display: block;
        max-width: 100%;
        max-height: 100%;
        border-radius: 0.5rem;
    }
    .lightbox-close-btn {
        position: absolute;
        top: -15px;
        right: -15px;
        background: white;
        color: #333;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .lightbox-close-btn:hover {
        transform: scale(1.1);
    }
</style>

<div class="container py-5">
    <div class="page-header">
        <h1 class="display-5">Review Donation Offer</h1>
        {# ## Added safety check for deleted user/need ## #}
        <p class="lead text-muted">From <strong>{% if offer.user %}{{ offer.user.first_name }} {{ offer.user.last_name }}{% else %}[Deleted User]{% endif %}</strong> for the need: <strong>{% if offer.need %}{{ offer.need.title }}{% else %}[Deleted Need]{% endif %}</strong></p>
    </div>

    <div class="row g-4 main-content">
        <div class="col-lg-8">
            {% if offer.status == 'Pending Review' %}
            <form method="POST">
                <div class="row g-4">
                    {% for item in offer.offered_items %}
                    <div class="col-md-6">
                        <div class="card h-100 item-card">
                            <img src="{{ url_for('static', filename=item.image_url or 'images/item_placeholder.jpg') }}" class="item-image enlargeable-image" alt="{{ item.title }}">
                            <div class="card-body">
                                <h5 class="card-title fw-bold">{{ item.title }}</h5>
                                <p class="card-text small text-muted">{{ item.description }}</p>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between"><span>Quantity:</span> <strong>{{ item.quantity }}</strong></li>
                                    <li class="list-group-item d-flex justify-content-between"><span>Condition:</span> <strong>{{ item.condition }}</strong></li>
                                    {% if item.manufacture_date %}
                                    <li class="list-group-item d-flex justify-content-between"><span>MFG Date:</span> <strong>{{ item.manufacture_date.strftime('%d %b %Y') }}</strong></li>
                                    {% endif %}
                                    {% if item.expiry_date %}
                                    <li class="list-group-item d-flex justify-content-between text-danger"><span>EXP Date:</span> <strong>{{ item.expiry_date.strftime('%d %b %Y') }}</strong></li>
                                    {% endif %}
                                </ul>
                            </div>
                            <div class="card-footer bg-transparent d-flex justify-content-around p-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="item_decision_{{ item.offered_item_id }}" id="accept_{{ item.offered_item_id }}" value="accept" checked>
                                    <label class="form-check-label" for="accept_{{ item.offered_item_id }}">Accept</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="item_decision_{{ item.offered_item_id }}" id="reject_{{ item.offered_item_id }}" value="reject">
                                    <label class="form-check-label" for="reject_{{ item.offered_item_id }}">Reject</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">Finalize Review</button>
                    <a href="{{ url_for('main.start_org_chat', offer_id=offer.offer_id) }}" class="btn btn-outline-secondary">Chat with User</a>
                </div>
            </form>
            {% else %}
                <div class="alert alert-info">This offer has already been reviewed. Current status: <strong>{{ offer.status }}</strong></div>

                {# --- THIS IS THE NEWLY ADDED PROOF CARD --- #}
                {% if offer.status == 'Completed' %}
                <div class="card proof-card mb-4">
                    <div class="card-header bg-transparent border-0 pt-3">
                        <h5 class="mb-0 fw-bold">Donation Proof</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">You marked this donation as complete. This is the proof you uploaded.</p>
                        {% if offer.proof_image_url %}
                            {# Use the direct static path fix we found earlier #}
                            <img src="/static/{{ offer.proof_image_url }}" 
                                 alt="Proof of Donation" 
                                 class="img-fluid rounded border enlargeable-image">
                        {% else %}
                            <p class="text-center text-muted">You did not provide a proof of donation image.</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {# --- END OF NEWLY ADDED PROOF CARD --- #}

                <div class="row g-4">
                    {% for item in offer.offered_items %}
                    <div class="col-md-6">
                        <div class="card h-100 item-card">
                            <img src="{{ url_for('static', filename=item.image_url or 'images/item_placeholder.jpg') }}" class="item-image enlargeable-image" alt="{{ item.title }}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h5 class="card-title fw-bold">{{ item.title }}</h5>
                                    {% if item.status == 'Accepted' %}
                                        <span class="badge bg-success fs-6">Accepted</span>
                                    {% elif item.status == 'Rejected' %}
                                        <span class="badge bg-danger fs-6">Rejected</span>
                                    {% else %}
                                        <span class="badge bg-secondary fs-6">{{ item.status }}</span>
                                    {% endif %}
                                </div>
                                <p class="card-text small text-muted">{{ item.description }}</p>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between"><span>Quantity:</span> <strong>{{ item.quantity }}</strong></li>
                                    <li class="list-group-item d-flex justify-content-between"><span>Condition:</span> <strong>{{ item.condition }}</strong></li>
                                    {% if item.manufacture_date %}
                                    <li class="list-group-item d-flex justify-content-between"><span>MFG Date:</span> <strong>{{ item.manufacture_date.strftime('%d %b %Y') }}</strong></li>
                                    {% endif %}
                                    {% if item.expiry_date %}
                                    <li class="list-group-item d-flex justify-content-between text-danger"><span>EXP Date:</span> <strong>{{ item.expiry_date.strftime('%d %b %Y') }}</strong></li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                 <div class="d-grid gap-2 mt-4">
                    <a href="{{ url_for('main.org_dashboard', filter='incoming') }}" class="btn btn-secondary">Back to Offers</a>
                    <a href="{{ url_for('main.start_org_chat', offer_id=offer.offer_id) }}" class="btn btn-outline-info">Chat with User</a>
                </div>
            {% endif %}
        </div>
        <div class="col-lg-4">
            <div class="card position-sticky top-0">
                <div class="card-body">
                    <h5 class="card-title fw-bold mb-3">Offer Summary</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between"><span>Status:</span> <span class="badge bg-info">{{ offer.status }}</span></li>
                        <li class="list-group-item d-flex justify-content-between"><span>Date Offered:</span> <strong>{{ offer.created_at.strftime('%d %b %Y') }}</strong></li>
                        
                        {# --- This is the fix for the 500 Error --- #}
                        <li class="list-group-item d-flex justify-content-between"><span>Items:</span> <strong>{{ offer.offered_items | length }}</strong></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="imageLightbox" class="lightbox-overlay">
    <div class="lightbox-content-wrapper">
        <img class="lightbox-content" id="lightboxImg">
        <span class="lightbox-close-btn" title="Close">&times;</span>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const lightbox = document.getElementById('imageLightbox');
    const lightboxImg = document.getElementById('lightboxImg');
    const closeBtn = document.querySelector('.lightbox-close-btn');
    const images = document.querySelectorAll('.enlargeable-image');

    images.forEach(image => {
        // Skip placeholders
        if (image.src.includes('item_placeholder.jpg')) return;
        
        image.addEventListener('click', function() {
            const imgSrc = this.src;
            if (lightbox) lightbox.classList.add('visible');
            if (lightboxImg) lightboxImg.src = imgSrc;
        });
    });

    const closeLightbox = () => {
        if (lightbox) {
            lightbox.classList.remove('visible');
        }
    };

    if (closeBtn) {
        closeBtn.addEventListener('click', closeLightbox);
    }
    if (lightbox) {
        lightbox.addEventListener('click', function(e) {
            if (e.target === lightbox) {
                closeLightbox();
            }
        });
    }
});
</script>
{% endblock %}