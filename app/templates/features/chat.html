{% extends "base.html" %}
{% block content %}

<style>
    /* ---------------------------------- */
    /* --- Modern Chat Interface Styles --- */
    /* ---------------------------------- */
    :root {
        --primary: hsl(210, 90%, 50%);
        --primary-light: hsl(210, 90%, 95%);
        --primary-foreground: hsl(0, 0%, 100%);
        --background: hsl(220, 15%, 96%);
        --card: hsl(0, 0%, 100%);
        --foreground: hsl(220, 10%, 15%);
        --muted-foreground: hsl(220, 5%, 50%);
        --border: hsl(220, 10%, 90%);
        --radius: 0.75rem;
    }
    .dark-mode {
        --primary: hsl(210, 90%, 60%);
        --primary-light: hsl(220, 15%, 20%);
        --background: hsl(240, 10%, 4%);
        --card: hsl(240, 4%, 16%);
        --foreground: hsl(0, 0%, 98%);
        --muted-foreground: hsl(220, 5%, 65%);
        --border: hsl(240, 4%, 25%);
    }

    /* Main Layout */
    .chat-container { display: flex; flex-direction: column; height: calc(100vh - 120px); background: var(--card); }
    .chat-header { display: flex; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); background: var(--card); flex-shrink: 0; }
    .chat-main { display: flex; flex-grow: 1; overflow: hidden; }
    .chat-header-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 1rem; }
    .chat-header-info h5 { font-weight: 600; color: var(--foreground); margin-bottom: 0; } /* Removed margin-bottom */
    .chat-header-info p { font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 0; }

    /* Message Area */
    .chat-messages { flex-grow: 1; padding: 1.5rem; overflow-y: auto; background: var(--background); }

    /* Message Bubbles & Actions */
    .msg { display: flex; align-items: flex-end; gap: 0.75rem; margin-bottom: 1.5rem; max-width: 75%; } /* Align items end */
    .msg-content { padding: 0.75rem 1rem; border-radius: var(--radius); min-width: 80px; word-wrap: break-word; } /* Added word-wrap */
    .msg-meta { font-size: 0.75rem; margin-top: 0.25rem; opacity: 0.8; }
    .msg.sent { margin-left: auto; flex-direction: row-reverse; }
    .msg.sent .msg-content { background: var(--primary); color: var(--primary-foreground); border-bottom-right-radius: 0.25rem; }
    .msg.sent .msg-meta { color: hsla(0, 0%, 100%, 0.7); text-align: right; }
    .msg.received { margin-right: auto; }
    .msg.received .msg-content { background: var(--card); color: var(--foreground); border: 1px solid var(--border); border-bottom-left-radius: 0.25rem; }
    .msg.received .msg-meta { color: var(--muted-foreground); }

    /* Other Styles */
    .msg-actions { opacity: 0; transition: opacity 0.2s ease; flex-shrink: 0; margin-bottom: 0.25rem; } /* Added margin */
    .msg:hover .msg-actions { opacity: 1; } /* Show on hover for any message */
    .delete-msg-btn { background: none; border: none; color: var(--muted-foreground); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; transition: background-color 0.2s, color 0.2s; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; } /* Adjusted size */
    .delete-msg-btn:hover { background-color: var(--background); color: var(--bs-danger); }
    .msg.sent .delete-msg-btn:hover { background-color: var(--primary-light); color: var(--bs-danger); } /* Specific hover for sent */
    .msg-content-deleted { font-style: italic; color: var(--muted-foreground); opacity: 0.8; }
    .header-action-btn { background-color: transparent; border: none; }
    .header-action-btn:hover { background-color: var(--background); }
    .chat-sidebar { width: 320px; border-left: 1px solid var(--border); padding: 1.5rem; background: var(--card); flex-shrink: 0; overflow-y: auto; }
    .sidebar-card { margin-bottom: 1.5rem; }
    .sidebar-card h6 { font-weight: 600; color: var(--foreground); margin-bottom: 1rem; }
    .item-preview img { width: 100%; border-radius: var(--radius); margin-bottom: 0.75rem; height: 150px; object-fit: cover; }
    .item-preview p { font-weight: 500; color: var(--foreground); margin-bottom: 0; }
    .chat-form { padding: 1rem 1.5rem; border-top: 1px solid var(--border); background: var(--card); }
    .chat-form-container { display: flex; align-items: center; gap: 0.75rem; }
    .chat-form-container .form-control { border-radius: 50px; background: var(--background); border-color: var(--border); color: var(--foreground); padding: 0.6rem 1.2rem; }
    .chat-btn { width: 44px; height: 44px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 1.1rem; border: none; background: transparent; color: var(--muted-foreground); transition: all 0.2s ease; }
    .chat-btn:hover { color: var(--primary); background: var(--primary-light); }
    .image-preview-container { position: relative; margin-bottom: 1rem; display: none; }
    .image-preview { max-width: 100px; max-height: 100px; border-radius: var(--radius); }
    .remove-image-btn { position: absolute; top: -10px; right: -10px; background: var(--bs-danger); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

    /* Sent/Received Image Styles */
    .chat-image { max-width: 100%; border-radius: var(--radius); margin-top: 0.5rem; cursor: pointer; transition: opacity 0.2s; }
    .chat-image:hover { opacity: 0.8; }

    /* --- Image Lightbox Styles --- */
    .lightbox-overlay { position: fixed; z-index: 1070; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.3s ease; }
    .lightbox-overlay.visible { display: flex; opacity: 1; }
    .lightbox-content-wrapper { position: relative; max-width: 90vw; max-height: 90vh; }
    .lightbox-content { display: block; max-width: 100%; max-height: 100%; border-radius: var(--radius); }
    .lightbox-close-btn, .lightbox-download-btn { position: absolute; top: 1rem; background: rgba(30, 30, 30, 0.7); color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; justify-content: center; text-decoration: none; }
    .lightbox-close-btn { right: 1rem; }
    .lightbox-download-btn { right: 4rem; }
    .lightbox-close-btn:hover, .lightbox-download-btn:hover { background: rgba(0, 0, 0, 0.9); }
    .confirm-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1050; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; }
    .confirm-modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
    .confirm-modal-box { background: var(--card); padding: 2rem; border-radius: var(--radius); width: 90%; max-width: 400px; transform: scale(0.9); transition: transform 0.3s ease; }
    .confirm-modal-overlay.active .confirm-modal-box { transform: scale(1); }
    .confirm-modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }

    /* --- NEW TABBED ITEM PREVIEW STYLES --- */
    .item-preview-tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
        margin-bottom: 1rem;
    }
    .item-preview-tab {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        color: var(--muted-foreground);
        font-weight: 500;
        transition: all 0.2s ease;
    }
    .item-preview-tab:hover {
        color: var(--foreground);
    }
    .item-preview-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }
    .item-preview-content {
        display: none;
    }
    .item-preview-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>

<div class="container-fluid p-0">
    <div class="chat-container">
        <div class="chat-header">
            {% if other_user %}
                <a href="{{ url_for('main.public_profile', user_id=other_user.user_id) }}" class="d-flex align-items-center text-decoration-none">
                    <img src="{{ url_for('static', filename=other_user.profile_picture or 'images/users_placeholder.png') }}" alt="{{ other_user.first_name }}" class="chat-header-img">
                    <div class="chat-header-info">
                        <h5>{{ other_user.first_name }} {{ other_user.last_name }}</h5>
                        <p>Discussing: {{ the_item.title }}</p>
                    </div>
                </a>
            {% elif organization %}
                 <div class="d-flex align-items-center text-decoration-none"> {# Not linking org profile for now #}
                    <img src="{{ url_for('static', filename=organization.profile_picture or 'images/orgs_placeholder.png') }}" alt="{{ organization.name }}" class="chat-header-img">
                    <div class="chat-header-info">
                        <h5>{{ organization.name }}</h5>
                        <p>Discussing: {{ the_item.title }}</p>
                    </div>
                </div>
            {% endif %}

            <div class="ms-auto d-flex align-items-center">
                {# Link to view item, only if it's a trade item chat #}
                {% if not session.is_org_chat and the_item and the_item.item_id %}
                    <a href="{{ url_for('main.view_item', item_id=the_item.item_id) }}" class="btn btn-sm btn-outline-secondary">View Item</a>
                {% endif %}
                <div class="dropdown ms-2">
                    <button class="btn btn-sm rounded-circle header-action-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="width:32px; height:32px;" title="More Options">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        {% if not session.is_org_chat %} {# Block/Report User only for user-user chats #}
                            <li>
                                <form action="{{ url_for('main.block_chat', session_id=session.session_id) }}" method="POST">
                                    <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Blocking this user will prevent further messages in this chat. Are you sure?')">
                                        <i class="fas fa-ban fa-fw me-2"></i>Block User
                                    </button>
                                </form>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                        {% endif %}
                        <li>
                            <a class="dropdown-item text-danger" href="{{ url_for('main.report_general', session_id=session.session_id) }}">
                                <i class="fas fa-flag fa-fw me-2"></i>Report Conversation
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="chat-main">
            <div class="chat-messages" id="chatBox">
                {% for msg in messages %}
                <div class="msg {% if (current_user.__class__.__name__ == 'User' and msg.sender_id == current_user.user_id and msg.sender_type == 'user') or (current_user.__class__.__name__ == 'Organization' and msg.sender_id == current_user.org_id and msg.sender_type == 'org') %}sent{% else %}received{% endif %}" id="msg-container-{{ msg.message_id }}">
                    <div class="msg-content">
                        {% if msg.deleted_at %}
                            <p class="mb-0 msg-content-deleted"><i class="fas fa-ban me-1"></i>Message deleted</p>
                        {% else %}
                            {% if msg.message %}<p class="mb-0">{{ msg.message }}</p>{% endif %}
                            {% if msg.image_url %}<img src="{{ url_for('static', filename=msg.image_url) }}" class="chat-image">{% endif %}
                        {% endif %}
                        <div class="msg-meta">{{ (msg.timestamp | localdatetime).strftime('%I:%M %p') }}</div>
                    </div>
                     {# Show delete button only if it's the sender's own message and not deleted #}
                    {% if ((current_user.__class__.__name__ == 'User' and msg.sender_id == current_user.user_id and msg.sender_type == 'user') or (current_user.__class__.__name__ == 'Organization' and msg.sender_id == current_user.org_id and msg.sender_type == 'org')) and not msg.deleted_at %}
                    <div class="msg-actions">
                        <button type="button" class="delete-msg-btn" data-message-id="{{ msg.message_id }}" title="Delete Message">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="text-center text-muted p-5">
                    <i class="fas fa-comments fs-3 my-3"></i>
                    <p>No messages yet. Start the conversation!</p>
                </div>
                {% endfor %}
            </div>

            <aside class="chat-sidebar">
                {# --- MODIFIED: Item Preview Logic for User-User ITEM TRADES --- #}
                {# Show this block ONLY for user-user chats about a Trade item that has a corresponding trade_request (i.e., not a 'Money' request) #}
                {% if not session.is_org_chat and the_item and the_item.item_id and the_item.type == 'Trade' and trade_request and trade_request.offered_item %}
                    {# We use the 'trade_request' object passed directly from the chat route #}

                    <div class="sidebar-card">
                        <div class="item-preview-tabs">
                            {# Renamed tab for clarity #}
                            <div class="item-preview-tab active" data-target="item-requested">Item Requested</div>
                            <div class="item-preview-tab" data-target="item-offered">Item Offered</div>
                        </div>

                        {# This is 'the_item' (the item the chat is about) #}
                        <div id="item-requested" class="item-preview-content active">
                            <a href="{{ url_for('main.view_item', item_id=the_item.item_id) }}" class="item-preview text-decoration-none">
                                <img src="{{ url_for('static', filename=the_item.images[0].image_url if the_item.images else 'images/item_placeholder.jpg') }}">
                                <p>{{ the_item.title }}</p>
                                {# 'the_item.owner' is the definitive owner. #}
                                <small class="text-muted d-block">Owned by: {{ the_item.owner.first_name }}</small>
                            </a>
                        </div>

                        {# This is the item from the trade_request #}
                        <div id="item-offered" class="item-preview-content">
                            <a href="{{ url_for('main.view_item', item_id=trade_request.offered_item.item_id) }}" class="item-preview text-decoration-none">
                                <img src="{{ url_for('static', filename=trade_request.offered_item.images[0].image_url if trade_request.offered_item.images else 'images/item_placeholder.jpg') }}">
                                <p>{{ trade_request.offered_item.title }}</p>
                                 {# 'trade_request.requester' is the definitive offerer. #}
                                <small class="text-muted d-block">Offered by: {{ trade_request.requester.first_name }}</small>
                            </a>
                        </div>
                    </div>

                {# --- ADDED: Fallback for SHARE or MONEY request items --- #}
                {% elif not session.is_org_chat and the_item and the_item.item_id and (the_item.type == 'Share' or (the_item.type == 'Trade' and the_item.expected_return == 'Money')) %}
                    <div class="sidebar-card">

                        {# ***** START OF CORRECTION ***** #}
                        <h6>
                            {% if the_item.type == 'Share' %}
                                Item for Share
                            {% elif the_item.type == 'Trade' and the_item.expected_return == 'Money' %}
                                Item for Trade (Money)
                            {% else %}
                                Item Context
                            {% endif %}
                        </h6>
                        {# ***** END OF CORRECTION ***** #}

                        <a href="{{ url_for('main.view_item', item_id=the_item.item_id) }}" class="item-preview text-decoration-none">
                            <img src="{{ url_for('static', filename=the_item.images[0].image_url if the_item.images else 'images/item_placeholder.jpg') }}">
                            <p>{{ the_item.title }}</p>
                        </a>
                    </div>
                {% endif %}
                {# --- END MODIFICATION --- #}


                {# --- Existing Context for Org-User Chats about Needs --- #}
                {% if session.is_org_chat and the_item and the_item.need_id %} {# Use direct attribute check #}
                    <div class="sidebar-card">
                        <h6>About this Conversation</h6>
                        <p class="small text-muted">This chat is regarding the disaster need post: <strong>{{ the_item.title }}</strong>.</p>
                        {# Optionally link to the need if needed: <a href="#">View Need Details</a> #}
                    </div>
                {% endif %}

                {# --- Display Donation Offer Status Panel for Org Chats (User name removed) --- #}
                {% if session.is_org_chat and donation_offer %}
                <div class="sidebar-card">
                    <h6>Donation Offer Status</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between px-0">
                            <span>Current Status:</span>
                            {# Use different badge colors based on status #}
                            {% set status_color = 'secondary' %} {# Default #}
                            {% if donation_offer.status == 'Pending Review' %} {% set status_color = 'warning text-dark' %}
                            {% elif donation_offer.status in ['Awaiting Pickup', 'Accepted', 'Partially Accepted'] %} {% set status_color = 'info' %}
                            {% elif donation_offer.status == 'Donation Pending' %} {% set status_color = 'primary' %}
                            {% elif donation_offer.status == 'Completed' %} {% set status_color = 'success' %}
                            {% elif donation_offer.status in ['Rejected', 'Pickup Failed'] %} {% set status_color = 'danger' %}
                            {% endif %}
                            <span class="badge bg-{{ status_color }} rounded-pill">{{ donation_offer.status }}</span>
                        </li>
                         {# ## USER NAME LIST ITEM REMOVED ## #}
                        <li class="list-group-item d-flex justify-content-between px-0">
                            <span>Items Offered:</span>
                            <strong>{{ donation_offer.offered_items|length }}</strong> {# Uses |length filter #}
                        </li>
                        {% if donation_offer.verified_at %}
                        <li class="list-group-item d-flex justify-content-between px-0">
                            <span>Reviewed On:</span>
                            <small>{{ (donation_offer.verified_at | localdatetime).strftime('%b %d, %Y') }}</small>
                        </li>
                        {% endif %}
                        {% if donation_offer.picked_up_at %}
                        <li class="list-group-item d-flex justify-content-between px-0">
                            <span>Picked Up On:</span>
                             <small>{{ (donation_offer.picked_up_at | localdatetime).strftime('%b %d, %Y') }}</small>
                        </li>
                        {% endif %}
                         {% if donation_offer.completed_at %}
                        <li class="list-group-item d-flex justify-content-between px-0">
                            <span>Completed On:</span>
                             <small>{{ (donation_offer.completed_at | localdatetime).strftime('%b %d, %Y') }}</small>
                        </li>
                        {% endif %}
                    </ul>
                    {# Add a link to view the offer if applicable #}
                    {% if current_user.__class__.__name__ == 'Organization' and donation_offer.status in ['Pending Review', 'Awaiting Pickup', 'Accepted', 'Partially Accepted', 'Donation Pending', 'Completed', 'Rejected', 'Pickup Failed'] %} {# Show for all reviewed/final states too #}
                        {% if current_user.__class__.__name__ == 'Organization' and donation_offer %} {# Simplified check #}
                            <div class="mt-3 d-grid">
                                 {# ***** CORRECTED LINK ***** #}
                                 <a href="{{ url_for('main.review_donation_offer', offer_id=donation_offer.offer_id) }}" class="btn btn-sm btn-outline-secondary">
                                     View Offer Details
                                 </a>
                                 {# ***** END CORRECTION ***** #}
                            </div>
                        {% endif %}
                         {# Also show View Offer for User #}
                         {% if current_user.__class__.__name__ == 'User' %}
                             <div class="mt-3 d-grid">
                                 <a href="{{ url_for('main.view_my_offer', offer_id=donation_offer.offer_id) }}" class="btn btn-sm btn-outline-secondary">
                                     View Offer Details
                                 </a>
                            </div>
                         {% endif %}
                    {% endif %}
                </div>
                {% endif %}
                {# --- END SECTION --- #}


                {# --- Existing Deal Panel (Only for User-User Chats) --- #}
                {% if not session.is_org_chat %}
                <div class="sidebar-card">
                    <h6>Deal Status</h6>
                    {% if session.status == 'Active' %}
                        {% include 'features/_deal_panel.html' %}
                    {% elif session.status == 'Confirmed' %}
                        <div class="alert alert-success text-center"><i class="fas fa-check-circle me-2"></i>Deal Confirmed!</div>
                    {% elif session.status == 'Blocked' %}
                        <div class="alert alert-danger text-center"><i class="fas fa-ban me-2"></i>Chat Blocked</div>
                    {% endif %}
                </div>
                {% endif %}
            </aside>
        </div>

        <div class="chat-form">
             {# Allow sending messages only if chat status is Active #}
            {% if session.status == 'Active' %}
            <form method="POST" enctype="multipart/form-data" id="chatForm">
                {{ form.hidden_tag() }}
                <div id="image-preview-container" class="image-preview-container">
                    <img id="image-preview" src="#" alt="Image Preview" class="image-preview"/>
                    <button type="button" id="remove-image-btn" class="remove-image-btn">&times;</button>
                </div>
                <div class="chat-form-container">
                    <label for="image-upload" class="chat-btn" role="button" title="Send Image"><i class="fas fa-paperclip"></i></label>
                    {{ form.image(id="image-upload", style="display:none;", accept="image/*") }}
                    {{ form.message(class="form-control", placeholder="Type a message...", autocomplete="off") }}
                    <button type="submit" class="chat-btn" style="color: var(--primary);" title="Send Message"><i class="fas fa-paper-plane"></i></button>
                </div>
            </form>
            {% else %}
            <p class="text-muted text-center mb-0">You can no longer send messages in this chat (Status: {{ session.status }}).</p>
            {% endif %}
        </div>
    </div>
</div>

{# Confirmation Modal for Deleting Messages #}
<div class="confirm-modal-overlay" id="deleteModal">
    <div class="confirm-modal-box">
        <h4 class="fw-bold">Delete Message?</h4>
        <p>Are you sure you want to permanently delete this message? This action cannot be undone.</p>
        <div class="confirm-modal-actions">
            <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
    </div>
</div>

{# ***** ADD THIS SCRIPT BLOCK ***** #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Tab Switching Logic ---
        const tabs = document.querySelectorAll('.item-preview-tab');
        const contents = document.querySelectorAll('.item-preview-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs and contents
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));

                // Add active class to the clicked tab and corresponding content
                this.classList.add('active');
                const targetId = this.getAttribute('data-target');
                const targetContent = document.getElementById(targetId);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            });
        });

        // --- Other Chat Page JS (like image preview, delete modal, etc.) ---
        // (Make sure any existing JS for image preview, delete confirmation, etc.
        //  is also within this DOMContentLoaded listener or similar)

        // Example: Scroll chatbox to bottom (if you don't have this already)
        const chatBox = document.getElementById('chatBox');
        if (chatBox) {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Add your existing JS for image preview handling here
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');

        if (imageUpload && imagePreviewContainer && imagePreview && removeImageBtn) {
            imageUpload.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreviewContainer.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                }
            });

            removeImageBtn.addEventListener('click', function() {
                imageUpload.value = ''; // Clear the file input
                imagePreview.src = '#';
                imagePreviewContainer.style.display = 'none';
            });
        }


        // Add your existing JS for delete confirmation modal here
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        let messageIdToDelete = null;

        document.querySelectorAll('.delete-msg-btn').forEach(button => {
            button.addEventListener('click', function() {
                messageIdToDelete = this.getAttribute('data-message-id');
                if (deleteModal) {
                    deleteModal.classList.add('active');
                }
            });
        });

        if (cancelDeleteBtn && deleteModal) {
            cancelDeleteBtn.addEventListener('click', function() {
                deleteModal.classList.remove('active');
                messageIdToDelete = null;
            });
        }

        if (confirmDeleteBtn && deleteModal) {
            confirmDeleteBtn.addEventListener('click', function() {
                if (messageIdToDelete) {
                    fetch(`/message/${messageIdToDelete}/delete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                             // ***** START CORRECTION *****
                             // Add CSRF token header if needed (get from hidden input)
                             // 'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value
                             // ***** END CORRECTION *****
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update UI: Replace message content or remove element
                            const msgContainer = document.getElementById(`msg-container-${messageIdToDelete}`);
                            if(msgContainer) {
                                const msgContentDiv = msgContainer.querySelector('.msg-content');
                                if (msgContentDiv) {
                                     msgContentDiv.innerHTML = `<p class="mb-0 msg-content-deleted"><i class="fas fa-ban me-1"></i>Message deleted</p><div class="msg-meta">${msgContentDiv.querySelector('.msg-meta')?.innerHTML || ''}</div>`;
                                }
                                // Remove the delete button itself
                                const deleteButtonDiv = msgContainer.querySelector('.msg-actions');
                                if(deleteButtonDiv) {
                                    deleteButtonDiv.remove();
                                }
                            }
                            deleteModal.classList.remove('active');
                            messageIdToDelete = null;
                        } else {
                            alert('Error deleting message: ' + data.error);
                            deleteModal.classList.remove('active');
                            messageIdToDelete = null;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the message.');
                        deleteModal.classList.remove('active');
                        messageIdToDelete = null;
                    });
                }
            });
        }
         // Close modal if clicking outside the box
         if (deleteModal) {
            deleteModal.addEventListener('click', function(event) {
                if (event.target === deleteModal) { // Clicked on the overlay itself
                    deleteModal.classList.remove('active');
                    messageIdToDelete = null;
                }
            });
        }

    });
</script>
{# ***** END SCRIPT BLOCK ***** #}

{% endblock %}