{% extends "base.html" %}
{% block content %}
<div class="container py-5">
    <h1 class="fw-bold">Offer Help for: {{ need.title }}</h1>
    <p class="text-muted">Requested by {{ need.organization.name }}</p>
    <div class="card card-body mb-4">
        {{ need.description }}
    </div>

    <form method="POST" enctype="multipart/form-data" novalidate>
        {{ form.hidden_tag() }}
        <div id="item-forms-container">
            </div>
        <button type="button" id="add-item-btn" class="btn btn-outline-secondary mt-3"><i class="fas fa-plus"></i> Add Another Item</button>
        <hr>
        <div class="d-grid">
            {{ form.submit(class="btn btn-success btn-lg") }}
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('item-forms-container');
    const addItemBtn = document.getElementById('add-item-btn');
    let itemIndex = 0;

    const criticalCategories = ['Medicines', 'Food & Snacks', 'Baby Products', 'Health & Wellness'];
    const categoryOptions = `
        {% for value, label in form.offered_items[0].category.choices %}
            <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
    `;

    function createItemForm(index, data = {}) {
        const wrapper = document.createElement('div');
        wrapper.classList.add('card', 'card-body', 'mb-3', 'item-form');
        wrapper.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Item #${index + 1}</h5>
                <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn">Remove</button>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="offered_items-${index}-title" class="form-label">Item Name <span class="text-danger">*</span></label>
                    <input type="text" id="offered_items-${index}-title" name="offered_items-${index}-title" class="form-control" value="${data.title || ''}" required>
                </div>
                <div class="col-md-6">
                    <label for="offered_items-${index}-category" class="form-label">Category <span class="text-danger">*</span></label>
                    <select id="offered_items-${index}-category" name="offered_items-${index}-category" class="form-select item-category-select" required>
                        ${categoryOptions}
                    </select>
                </div>
                <div class="col-12">
                    <label for="offered_items-${index}-description" class="form-label">Description</label>
                    <textarea id="offered_items-${index}-description" name="offered_items-${index}-description" class="form-control" rows="1">${data.description || ''}</textarea>
                </div>
                <div class="col-md-6">
                    <label for="offered_items-${index}-quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                    <input type="number" id="offered_items-${index}-quantity" name="offered_items-${index}-quantity" class="form-control" value="${data.quantity || 1}" min="1" required>
                </div>
                <div class="col-md-6">
                    <label for="offered_items-${index}-condition" class="form-label">Condition <span class="text-danger">*</span></label>
                    <select id="offered_items-${index}-condition" name="offered_items-${index}-condition" class="form-select" required>
                        <option value="New" ${data.condition === 'New' ? 'selected' : ''}>New</option>
                        <option value="Used" ${data.condition === 'Used' ? 'selected' : ''}>Used</option>
                    </select>
                </div>
                <div class="col-12">
                    <label for="offered_items-${index}-image" class="form-label">Image (Optional)</label>
                    <input type="file" id="offered_items-${index}-image" name="offered_items-${index}-image" class="form-control" accept="image/*">
                </div>
                
                <div class="col-12 critical-info-wrapper" style="display: none;">
                    <hr>
                    <p class="small text-muted mb-2">Please provide details for this critical item:</p>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="offered_items-${index}-manufacture_date" class="form-label">Manufacture Date <span class="text-danger critical-required" style="display: none;">*</span></label>
                            <input type="date" id="offered_items-${index}-manufacture_date" name="offered_items-${index}-manufacture_date" class="form-control" value="${data.manufacture_date || ''}">
                        </div>
                        <div class="col-md-6">
                            <label for="offered_items-${index}-expiry_date" class="form-label">Expiry Date <span class="text-danger critical-required" style="display: none;">*</span></label>
                            <input type="date" id="offered_items-${index}-expiry_date" name="offered_items-${index}-expiry_date" class="form-control" value="${data.expiry_date || ''}">
                        </div>
                    </div>
                </div>
            </div>
        `;

        const categorySelect = wrapper.querySelector('.item-category-select');
        const criticalWrapper = wrapper.querySelector('.critical-info-wrapper');
        const mfgDate = wrapper.querySelector(`[name="offered_items-${index}-manufacture_date"]`);
        const expDate = wrapper.querySelector(`[name="offered_items-${index}-expiry_date"]`);
        const criticalAsterisks = wrapper.querySelectorAll('.critical-required');

        if(data.category) {
            categorySelect.value = data.category;
        }

        function toggleCriticalFields() {
            const isCritical = criticalCategories.includes(categorySelect.value);
            criticalWrapper.style.display = isCritical ? 'block' : 'none';
            
            mfgDate.required = isCritical;
            expDate.required = isCritical;
            criticalAsterisks.forEach(el => el.style.display = isCritical ? 'inline' : 'none');
        }
        
        categorySelect.addEventListener('change', toggleCriticalFields);
        toggleCriticalFields();
        
        wrapper.querySelector('.remove-item-btn').addEventListener('click', () => {
            wrapper.remove();
            document.querySelectorAll('.item-form h5').forEach((h5, i) => h5.textContent = `Item #${i + 1}`);
        });

        return wrapper;
    }

    function addNewItem(data) {
        const newItemForm = createItemForm(itemIndex, data);
        container.appendChild(newItemForm);
        itemIndex++;
    }

    // Add the first blank item form when the page loads
    addNewItem();

    // Allow the user to add more items
    addItemBtn.addEventListener('click', () => addNewItem());
});
</script>
{% endblock %}