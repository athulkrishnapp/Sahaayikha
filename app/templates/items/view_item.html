{% extends "base.html" %}
{% block content %}

<style>
    /* ---------------------------------- */
    /* --- Modern View Item Styles --- */
    /* ---------------------------------- */
    :root {
        --primary-light: hsl(210, 100%, 97%);
        --primary-dark: hsl(210, 10%, 23%);
        --border-color: #dee2e6;
        --border-color-dark: rgba(255, 255, 255, 0.1);
        --card-bg-dark: #2c2c3a;
    }
    .dark-mode { /* Dark mode adjustments */
      --primary-light: var(--primary-dark);
      --primary-dark: hsl(210, 10%, 30%); /* Slightly lighter dark */
      --border-color: var(--border-color-dark);
    }


    /* Image Gallery */
    .gallery-container .main-image-viewer {
        width: 100%;
        aspect-ratio: 16 / 10; /* Slightly taller */
        background-color: var(--bs-secondary-bg);
        border-radius: 0.75rem;
        overflow: hidden;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: transform 0.3s ease;
        position: relative; /* For placeholder text */
        display: flex; /* For centering placeholder */
        justify-content: center;
        align-items: center;
    }
    .gallery-container .main-image-viewer:hover {
        transform: scale(1.02);
    }
    .gallery-container .main-image-viewer img {
        width: 100%; height: 100%; object-fit: contain; /* Changed to contain */
    }
    .gallery-container .main-image-viewer .placeholder-text {
        color: var(--bs-secondary-color);
        font-style: italic;
    }


    .thumbnail-strip { display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 5px;} /* Allow horizontal scroll */
    .thumbnail-item {
        flex-shrink: 0; /* Prevent thumbnails from shrinking */
        width: 80px; height: 60px; border-radius: 0.5rem;
        overflow: hidden; cursor: pointer; border: 2px solid transparent;
        transition: border-color 0.2s ease, opacity 0.2s ease; opacity: 0.7; /* Slightly more visible */
    }
    .thumbnail-item:hover { opacity: 1; }
    .thumbnail-item.active { border-color: var(--bs-primary); opacity: 1; }
    .thumbnail-item img { width: 100%; height: 100%; object-fit: cover; }

    /* Item Info Section */
    .item-title { font-weight: 700; margin-bottom: 0.5rem; }
    .item-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; align-items: center; } /* Align badges */
    .detail-badge {
        font-size: 0.8rem; padding: 0.3rem 0.75rem;
        background-color: var(--bs-secondary-bg); /* Use secondary bg */
        color: var(--bs-emphasis-color); /* Use emphasis text color */
        border: 1px solid var(--border-color); /* Add border */
        border-radius: 50px;
        white-space: nowrap; /* Prevent wrapping */
    }
    .item-description {
        line-height: 1.6;
        white-space: pre-wrap; /* Preserve line breaks */
        margin-top: 1rem; /* Add space above description */
        color: var(--bs-secondary-color); /* Slightly muted color */
    }

    /* Action Buttons */
    .action-buttons { border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1.5rem; }
    .action-buttons .btn { font-weight: 500; }

    /* Right Sidebar Cards */
    .sidebar-card {
        border-radius: 0.75rem;
        border: 1px solid var(--border-color);
        padding: 1.5rem;
        background-color: var(--bs-body-bg); /* Match base background */
    }
    .dark-mode .sidebar-card {
        background-color: var(--card-bg-dark); /* Specific dark background */
    }
    .owner-info { display: flex; align-items: center; gap: 1rem; }
    .owner-info img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; border: 1px solid var(--border-color);}
    .details-list { list-style: none; padding: 0; margin: 0; }
    .details-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
    .details-list li:last-child { border-bottom: none; padding-bottom: 0; }
    .details-list li:first-child { padding-top: 0; }
    .details-list li span:first-child { color: var(--bs-secondary-color); /* Muted color for labels */ padding-right: 1rem; } /* Add padding */
    .details-list li span:last-child { text-align: right; } /* Align value to right */


    /* Lightbox Modal Styles */
    @keyframes lightboxZoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .lightbox { display: none; position: fixed; z-index: 1060; inset: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); justify-content: center; align-items: center; }
    .lightbox.visible { display: flex; }
    .lightbox-content { max-width: 90%; max-height: 85%; object-fit: contain; animation: lightboxZoomIn 0.3s ease; }
    .lightbox-close { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; line-height: 1; } /* Added line-height */
    .lightbox-close:hover { color: #bbb; }

    .copy-feedback { font-size: 0.8em; color: var(--bs-success); margin-left: 5px; }
    .pending-trade-message { color: var(--bs-secondary-color); font-size: 0.85rem; margin-top: 0.5rem; margin-bottom: 0; }

    /* Incoming Trade Request Styling */
    .trade-request-item .list-group-item { transition: background-color 0.2s ease; }
    .trade-request-item .list-group-item:hover { background-color: var(--bs-light); }
    .dark-mode .trade-request-item .list-group-item:hover { background-color: var(--bs-dark-bg-subtle); }
    .trade-request-item img { border: 1px solid var(--border-color); }

</style>

<div class="container py-5">
    {# --- Finalized Deal Alert --- #}
    {% if item.deal_finalized_at %}
    <div class="alert alert-info text-center shadow-sm mb-4" role="alert">
      <h4 class="alert-heading mb-1"><i class="fas fa-check-circle me-2"></i>Deal Finalized!</h4>
      <p class="mb-0">This item has been <strong>{{ 'shared' if item.type == 'Share' else 'traded' }}</strong> on {{ (item.deal_finalized_at | localdatetime).strftime('%b %d, %Y') }} and is no longer available.</p>
    </div>
    {% endif %}

    <div class="row g-4 g-lg-5">
        {# --- Left Column: Images & Info --- #}
        <div class="col-lg-7">
            {% set images = item.images %}
            <div class="gallery-container mb-4">
                 <div class="main-image-viewer shadow-sm" id="mainImageViewer">
                    {% if images %}
                        <img id="mainImage" src="{{ url_for('static', filename=images[0].image_url) }}" alt="{{ item.title }}">
                    {% else %}
                        <img id="mainImage" src="{{ url_for('static', filename='images/item_placeholder.jpg') }}" alt="No image available">
                    {% endif %}
                </div>
                {% if images|length > 1 %}
                <div class="thumbnail-strip">
                    {% for image in images %}
                    <div class="thumbnail-item {% if loop.first %}active{% endif %}" data-src="{{ url_for('static', filename=image.image_url) }}">
                        <img src="{{ url_for('static', filename=image.image_url) }}" alt="Thumbnail {{ loop.index }}">
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <h1 class="item-title mb-2">{{ item.title }}</h1>
            <div class="item-meta">
                <a href="{{ url_for('main.category_items', category_name=item.category) }}" class="detail-badge text-decoration-none">{{ item.category }}</a>
                {% if item.sub_category %}
                <span class="detail-badge">{{ item.sub_category }}</span>
                {% endif %}
                <span class="detail-badge"><i class="fas fa-{{ 'tools' if item.condition == 'Needs Repair' else ('star-half-alt' if item.condition in ['Good', 'Fair'] else 'star') }} me-1"></i>{{ item.condition }}</span>
                <span class="detail-badge"><i class="fas fa-exclamation-circle me-1"></i>{{ item.urgency_level or 'Not Specified' }}</span>
            </div>
            {% if item.description %}
            <p class="item-description">{{ item.description }}</p>
            {% else %}
             <p class="item-description fst-italic">No description provided.</p>
            {% endif %}

            {# --- Action Buttons --- #}
            <div class="action-buttons d-flex flex-wrap gap-2 align-items-center">
                 <button type="button" class="btn btn-sm btn-outline-secondary share-button" title="Copy link to this item" onclick="copyCurrentPageLink(this);">
                     <i class="fas fa-share-alt me-1"></i>Share<span class="copy-feedback ms-1" style="display: none;">Copied!</span>
                 </button>

                {% if current_user.is_authenticated %}
                    {% if current_user.__class__.__name__ == 'User' %}
                        {# Reviewing an incoming offer #}
                        {% if context_trade_request and current_user.user_id == context_trade_request.owner_id %}
                           {# ... (Incoming offer buttons remain same) ... #}
                            <p class="text-muted my-auto small ms-2">Reviewing offer for: <strong>{{ context_trade_request.requested_item.title }}</strong></p>
                            <div class="ms-auto d-flex gap-2">
                                <form action="{{ url_for('main.accept_trade', request_id=context_trade_request.id) }}" method="POST" class="d-inline">
                                    {{ g.csrf_token() if g and g.csrf_token else '' }} {# Manual CSRF if needed #}
                                    <button type="submit" class="btn btn-sm btn-success"><i class="fas fa-check me-1"></i>Accept & Chat</button>
                                </form>
                                <form action="{{ url_for('main.reject_trade', request_id=context_trade_request.id) }}" method="POST" class="d-inline">
                                     {{ g.csrf_token() if g and g.csrf_token else '' }}
                                    <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-times me-1"></i>Reject</button>
                                </form>
                            </div>
                        {# Owner's view #}
                        {% elif current_user.user_id == item.user_id %}
                             {# ... (Owner buttons remain same) ... #}
                            <a href="{{ url_for('main.edit_item', item_id=item.item_id) }}" class="btn btn-sm btn-warning"><i class="fas fa-edit me-1"></i>Edit</a>
                            <form action="{{ url_for('main.delete_item', item_id=item.item_id) }}" method="POST" class="d-inline">
                                 {{ g.csrf_token() if g and g.csrf_token else '' }}
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this item? This action cannot be undone.');"><i class="fas fa-trash me-1"></i>Delete</button>
                            </form>
                             <a href="{{ url_for('main.item_history', item_id=item.item_id) }}" class="btn btn-sm btn-outline-info ms-auto"><i class="fas fa-history me-1"></i>View History</a>
                        {# Viewer's view (not owner) #}
                        {% else %}
                             {# ... (Bookmark, Trade/Share/Chat, Report buttons remain same) ... #}
                             <form action="{{ url_for('main.add_or_remove_bookmark', item_id=item.item_id) }}" method="POST" class="d-inline">
                                {{ g.csrf_token() if g and g.csrf_token else '' }}
                                {% if is_bookmarked %}
                                    <button type="submit" class="btn btn-sm btn-primary"><i class="fas fa-bookmark me-1"></i>Bookmarked</button>
                                {% else %}
                                    <button type="submit" class="btn btn-sm btn-outline-primary"><i class="far fa-bookmark me-1"></i>Bookmark</button>
                                {% endif %}
                            </form>
                            {% if not item.deal_finalized_at %}
                                <div class="trade-action-wrapper d-inline-block">
                                    {% if item.type == 'Trade' %}
                                        {# Trade Request / Chat Button Logic #}
                                        {% if trade_request and trade_request.status == 'accepted' %}
                                            <a href="{{ url_for('main.chat', session_id=session.session_id) }}" class="btn btn-sm btn-success"><i class="fas fa-comments me-1"></i>Go to Trade Chat</a>
                                        {% elif trade_request and trade_request.status == 'pending' %}
                                            <button class="btn btn-sm btn-secondary" disabled><i class="fas fa-clock me-1"></i>Request Sent</button>
                                        {% else %}
                                            <a href="{{ url_for('main.request_trade', item_id=item.item_id) }}" class="btn btn-sm btn-success">
                                                <i class="fas fa-{{ 'dollar-sign' if item.expected_return_category == 'Money' else 'exchange-alt' }} me-1"></i> {# Check category field #}
                                                {{ 'Make Offer' if item.expected_return_category == 'Money' else 'Request Trade' }} {# Check category field #}
                                            </a>
                                        {% endif %}
                                    {% elif item.type == 'Share' %}
                                        {# Share Chat Button #}
                                         {% if session %} {# Check if chat already exists #}
                                            <a href="{{ url_for('main.chat', session_id=session.session_id) }}" class="btn btn-sm btn-success"><i class="fas fa-comments me-1"></i>Go to Share Chat</a>
                                         {% else %}
                                            <a href="{{ url_for('main.start_share_chat', item_id=item.item_id) }}" class="btn btn-sm btn-success"><i class="fas fa-comments me-1"></i>Chat about Receiving</a>
                                         {% endif %}
                                    {% endif %}
                                </div>
                            {% endif %} {# End check not finalized #}
                            <a href="{{ url_for('main.report_general', item_id=item.item_id) }}" class="btn btn-sm btn-outline-danger ms-auto"><i class="fas fa-flag me-1"></i>Report Item</a>
                        {% endif %}
                    {% elif current_user.__class__.__name__ == 'Organization' %}
                        <a href="{{ url_for('main.report_general', item_id=item.item_id) }}" class="btn btn-sm btn-outline-danger ms-auto"><i class="fas fa-flag me-1"></i>Report Item</a>
                    {% endif %}
                {% else %}
                    <a href="{{ url_for('main.login', next=request.url) }}" class="btn btn-sm btn-primary"><i class="fas fa-sign-in-alt me-1"></i>Login to interact</a>
                {% endif %}
            </div>

        </div>

        {# --- Right Column: Sidebar --- #}
        <div class="col-lg-5">
            <div class="d-flex flex-column gap-4">
                {# --- Owner Info Card --- #}
                <div class="sidebar-card shadow-sm">
                   {# ... (Owner info remains same) ... #}
                    <h5 class="fw-bold mb-3 border-bottom pb-2">Posted By</h5>
                     <a href="{{ url_for('main.public_profile', user_id=item.owner.user_id) }}" class="owner-info text-decoration-none text-body">
                        <img src="{{ url_for('static', filename=item.owner.profile_picture or 'images/users_placeholder.png') }}" alt="{{ item.owner.first_name }}">
                        <div>
                            <h6 class="fw-bold mb-0">{{ item.owner.first_name }} {{ item.owner.last_name or '' }}</h6>
                            <small class="text-muted d-block"><i class="fas fa-map-marker-alt me-1"></i>{{ item.owner.location or 'Location not set' }}</small>
                             <small class="text-muted d-block"><i class="fas fa-user-clock me-1"></i>Joined {{ item.owner.created_at.strftime('%b %Y') if item.owner.created_at else 'N/A' }}</small>
                        </div>
                    </a>
                </div>

                {# --- Item Details Card --- #}
                <div class="sidebar-card shadow-sm">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">Item Details</h5>
                    <ul class="details-list">
                        <li><span>Posted On</span> <strong>{{ (item.created_at | localdatetime).strftime('%b %d, %Y %I:%M %p') }}</strong></li>
                        <li><span>Status</span> <strong>{{ item.status }}</strong></li>
                        <li><span>Item Type</span> <strong>{{ item.type }}</strong></li>
                        <li><span>Location</span> <strong>{{ item.location or '—' }}</strong></li>
                        {# --- *** MODIFIED EXPECTED RETURN DISPLAY *** --- #}
                        {% if item.type == 'Trade' %}
                            <li>
                                <span>Expected Return</span>
                                <strong>
                                    {{ item.expected_return_category or '—' }}
                                    {% if item.expected_return_sub_category %}
                                        ({{ item.expected_return_sub_category }})
                                    {% endif %}
                                </strong>
                            </li>
                        {% endif %}
                        {# --- *** END MODIFICATION *** --- #}
                         {% if item.deal_finalized_at %}
                             <li><span>{{ 'Traded' if item.type == 'Trade' else 'Shared' }} On</span> <strong>{{ (item.deal_finalized_at | localdatetime).strftime('%b %d, %Y') }}</strong></li>
                         {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    {# --- Incoming Trade Requests Section --- #}
    {% if current_user.is_authenticated and current_user.__class__.__name__ == 'User' and current_user.user_id == item.user_id and item.type == 'Trade' and not item.deal_finalized_at %}
       {# ... (Incoming trade requests section remains largely the same, but you might want to display sub-category of offered item) ... #}
        <div class="row mt-5">
            <div class="col-12">
                 <h4 class="mb-3 border-bottom pb-2">
                     <i class="fas fa-exchange-alt me-2 text-primary"></i> Incoming Trade Requests
                     {% if incoming_trade_requests %}
                        <span class="badge bg-danger rounded-pill ms-2">{{ incoming_trade_requests|length }} New</span>
                     {% endif %}
                 </h4>
                {% if incoming_trade_requests %}
                    <div class="list-group trade-request-item shadow-sm">
                        {% for request in incoming_trade_requests %}
                        <div class="list-group-item list-group-item-action mb-2 border rounded p-3">
                            <div class="d-flex w-100 justify-content-between mb-2">
                                <h6 class="mb-0 fw-bold">{{ request.requester.first_name }} wants to trade!</h6>
                                <small class="text-muted">{{ (request.created_at | localdatetime).strftime('%Y-%m-%d %I:%M %p') }}</small>
                            </div>
                            <div class="d-sm-flex align-items-center my-2">
                                {% if request.offered_item %}
                                    <img src="{{ url_for('static', filename=request.offered_item.images[0].image_url if request.offered_item.images else 'images/item_placeholder.jpg') }}"
                                        style="width: 70px; height: 70px; object-fit: cover; border-radius: 0.3rem; margin-right: 1rem; margin-bottom: 0.5rem;"
                                        alt="{{ request.offered_item.title }}" class="flex-shrink-0">
                                    <p class="mb-0 small flex-grow-1">
                                        Offering: <strong>{{ request.offered_item.title }}</strong>
                                        {# Optionally display offered item's sub-category #}
                                        <span class="d-block text-muted">({{ request.offered_item.category }}{% if request.offered_item.sub_category %} - {{ request.offered_item.sub_category }}{% endif %}, {{ request.offered_item.condition }})</span>
                                    </p>
                                    <div class="mt-2 mt-sm-0 ms-sm-auto d-flex gap-2 flex-shrink-0 align-self-start align-self-sm-center">
                                         <a href="{{ url_for('main.view_item', item_id=request.offered_item.item_id, context_trade_id=request.id) }}" class="btn btn-outline-secondary btn-sm" title="View Offered Item Details">
                                             <i class="fas fa-eye"></i> View Item
                                         </a>
                                         <form action="{{ url_for('main.accept_trade', request_id=request.id) }}" method="POST" class="d-inline">
                                            {{ g.csrf_token() if g and g.csrf_token else '' }}
                                            <button type="submit" class="btn btn-success btn-sm"><i class="fas fa-check me-1"></i> Accept</button>
                                        </form>
                                        <form action="{{ url_for('main.reject_trade', request_id=request.id) }}" method="POST" class="d-inline">
                                            {{ g.csrf_token() if g and g.csrf_token else '' }}
                                            <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-times me-1"></i> Reject</button>
                                        </form>
                                    </div>
                                {% else %} {# Money offer #}
                                    <p class="mb-0 small flex-grow-1">
                                        <i class="fas fa-dollar-sign me-1 text-success"></i> Offering: <strong>Money</strong>
                                        <span class="d-block text-muted">(Details to be discussed in chat)</span>
                                    </p>
                                     <div class="mt-2 mt-sm-0 ms-sm-auto d-flex gap-2 flex-shrink-0 align-self-start align-self-sm-center">
                                         <form action="{{ url_for('main.accept_trade', request_id=request.id) }}" method="POST" class="d-inline">
                                            {{ g.csrf_token() if g and g.csrf_token else '' }}
                                            <button type="submit" class="btn btn-success btn-sm"><i class="fas fa-comments me-1"></i> Accept & Chat</button>
                                        </form>
                                        <form action="{{ url_for('main.reject_trade', request_id=request.id) }}" method="POST" class="d-inline">
                                            {{ g.csrf_token() if g and g.csrf_token else '' }}
                                            <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-times me-1"></i> Reject</button>
                                        </form>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                     <p class="text-muted text-center border rounded p-3 bg-light dark-mode:bg-dark-bg-subtle shadow-sm"><i class="fas fa-info-circle me-2"></i>You have no pending trade requests for this item.</p>
                {% endif %}
            </div>
        </div>
    {% endif %}

</div>

{# --- Lightbox Modal --- #}
<div class="lightbox" id="lightbox">
    <span class="lightbox-close" id="lightboxClose">&times;</span>
    <img class="lightbox-content" id="lightboxImage" src="">
</div>

<script>
// --- Copy Link & Lightbox & Thumbnail JS (Same as before) ---
 function copyCurrentPageLink(buttonElement) { /* ... (same copy logic) ... */
    const url = window.location.href; const fb = buttonElement.querySelector('.copy-feedback'); navigator.clipboard.writeText(url).then(() => { fb.style.display = 'inline'; buttonElement.disabled = true; setTimeout(() => { fb.style.display = 'none'; buttonElement.disabled = false; }, 1500); }).catch(err => { console.error('Copy failed:', err); fb.textContent = 'Failed!'; fb.style.color = 'red'; fb.style.display = 'inline'; setTimeout(() => { fb.style.display = 'none'; fb.textContent = 'Copied!'; fb.style.color = 'var(--bs-success)'; buttonElement.disabled = false; }, 2000); });
 }
 document.addEventListener('DOMContentLoaded', () => { const mainImg = document.getElementById('mainImage'); const thumbs = document.querySelectorAll('.thumbnail-item'); thumbs.forEach(t => { t.addEventListener('click', function() { const src = this.dataset.src; if (mainImg && src) { mainImg.src = src; thumbs.forEach(th => th.classList.remove('active')); this.classList.add('active'); } }); }); const viewer = document.getElementById('mainImageViewer'); const lb = document.getElementById('lightbox'); const lbImg = document.getElementById('lightboxImage'); const lbClose = document.getElementById('lightboxClose'); viewer?.addEventListener('click', () => { if (mainImg && mainImg.src && !mainImg.src.includes('placeholder') && lb && lbImg) { lbImg.src = mainImg.src; lb.classList.add('visible'); } }); lbClose?.addEventListener('click', () => lb?.classList.remove('visible')); lb?.addEventListener('click', (e) => { if (e.target === lb) lb.classList.remove('visible'); }); });
</script>

{% endblock %}