{% extends "base.html" %}
{% block content %}

<style>
    /* ---------------------------------- */
    /* --- Modern View Item Styles --- */
    /* ---------------------------------- */
    :root {
        --primary-light: hsl(210, 100%, 97%);
        --primary-dark: hsl(210, 10%, 23%);
        --border-color: #dee2e6;
        --border-color-dark: rgba(255, 255, 255, 0.1);
        --card-bg-dark: #2c2c3a;
    }

    /* Image Gallery */
    .gallery-container .main-image-viewer {
        width: 100%;
        aspect-ratio: 16 / 9;
        background-color: var(--bs-secondary-bg);
        border-radius: 0.75rem;
        overflow: hidden;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: transform 0.3s ease;
    }
    .gallery-container .main-image-viewer:hover {
        transform: scale(1.02);
    }
    .dark-mode .gallery-container .main-image-viewer {
        border-color: var(--border-color-dark);
    }
    .gallery-container .main-image-viewer img {
        width: 100%; height: 100%; object-fit: cover;
    }

    .thumbnail-strip { display: flex; gap: 0.75rem; }
    .thumbnail-item {
        width: 80px; height: 60px; border-radius: 0.5rem;
        overflow: hidden; cursor: pointer; border: 2px solid transparent;
        transition: border-color 0.2s ease; opacity: 0.6;
    }
    .thumbnail-item:hover { opacity: 1; }
    .thumbnail-item.active { border-color: var(--bs-primary); opacity: 1; }
    .thumbnail-item img { width: 100%; height: 100%; object-fit: cover; }

    /* Item Info Section */
    .item-title { font-weight: 700; margin-bottom: 0.5rem; }
    .item-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
    .detail-badge {
        font-size: 0.8rem; padding: 0.3rem 0.75rem;
        background-color: var(--primary-light); color: var(--bs-primary-text-emphasis);
        border-radius: 50px;
    }
    .dark-mode .detail-badge {
        background-color: var(--primary-dark); color: var(--bs-light);
    }
    .item-description {
        line-height: 1.6;
        white-space: pre-wrap; /* Correction for line breaks */
    }

    /* Action Buttons */
    .action-buttons { border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1.5rem; }
    .dark-mode .action-buttons { border-top-color: var(--border-color-dark); }
    .action-buttons .btn { font-weight: 500; }

    /* Right Sidebar Cards */
    .sidebar-card {
        border-radius: 0.75rem;
        border: 1px solid var(--border-color);
        padding: 1.5rem;
    }
    .dark-mode .sidebar-card {
        background-color: var(--card-bg-dark);
        border-color: var(--border-color-dark);
    }
    .owner-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .owner-info img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 50%;
    }
    .details-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .details-list li {
        display: flex;
        justify-content: space-between;
        align-items: center; /* Vertically align items */
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem; /* Slightly smaller font */
    }
    .dark-mode .details-list li {
        border-bottom-color: var(--border-color-dark);
    }
    .details-list li:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    .details-list li:first-child {
        padding-top: 0;
    }
    .details-list li span {
        color: var(--bs-secondary-color); /* Muted color for labels */
    }

    /* Lightbox Modal Styles */
    @keyframes lightboxZoomIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    .lightbox {
        display: none; position: fixed; z-index: 1060;
        inset: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
        justify-content: center; align-items: center;
    }
    .lightbox.visible { display: flex; }
    .lightbox-content {
        max-width: 90%; max-height: 85%; object-fit: contain;
        animation: lightboxZoomIn 0.3s ease;
    }
    .lightbox-close {
        position: absolute; top: 20px; right: 30px;
        color: #fff; font-size: 40px; font-weight: bold;
        transition: 0.3s; cursor: pointer;
    }
    .lightbox-close:hover { color: #bbb; }

    .copy-feedback { /* Ensure this style exists */
        font-size: 0.8em;
        color: var(--bs-success);
        margin-left: 5px;
    }
    .pending-trade-message { /* Style for the new message */
        color: var(--bs-secondary-color);
        font-size: 0.85rem;
        margin-top: 0.5rem;
        margin-bottom: 0;
    }
</style>

<div class="container py-5">
    {% if item.deal_finalized_at %}
    <div class="alert alert-info text-center" role="alert">
      <h4 class="alert-heading">Deal Finalized!</h4>
      <p>This item has been traded and is no longer available.</p>
    </div>
    {% endif %}
    <div class="row g-5">
        <div class="col-lg-7">
            {% set images = item.images %}
            <div class="gallery-container mb-4">
                <div class="main-image-viewer shadow-sm" id="mainImageViewer">
                    <img id="mainImage" src="{% if images %}{{ url_for('static', filename=images[0].image_url) }}{% else %}{{ url_for('static', filename='images/item_placeholder.jpg') }}{% endif %}" alt="{{ item.title }}">
                </div>
                {% if images|length > 1 %}
                <div class="thumbnail-strip">
                    {% for image in images %}
                    <div class="thumbnail-item {% if loop.first %}active{% endif %}">
                        <img src="{{ url_for('static', filename=image.image_url) }}" alt="Thumbnail {{ loop.index }}">
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <h1 class="item-title">{{ item.title }}</h1>
            <div class="item-meta">
                <a href="{{ url_for('main.category_items', category_name=item.category) }}" class="detail-badge text-decoration-none">{{ item.category }}</a>
                <span class="detail-badge">{{ item.condition }}</span>
                <span class="detail-badge">{{ item.urgency_level }}</span>
            </div>
            <p class="item-description text-muted">{{ item.description }}</p>

            <div class="action-buttons d-flex flex-wrap gap-2 align-items-center"> {# Added flex-wrap and align-items-center #}
                {# --- Start Conditional Button Logic --- #}

                {# Share Button - Always shown #}
                <button type="button" class="btn btn-outline-secondary share-button" title="Copy link to this item" onclick="copyCurrentPageLink(this);"><i class="fas fa-share-alt me-2"></i>Share<span class="copy-feedback ms-1" style="display: none;">Copied!</span></button>

                {% if current_user.is_authenticated %}
                    {# --- User-Specific Actions --- #}
                    {% if current_user.__class__.__name__ == 'User' %}
                        {# ... (user button logic remains the same) ... #}
                        {% if context_trade_request and current_user.user_id == context_trade_request.owner_id %}
                            <p class="text-muted my-auto">You are reviewing this item for a trade. Your item is: <strong>{{ context_trade_request.requested_item.title }}</strong></p>
                            <div class="ms-auto d-flex gap-2">
                                <form action="{{ url_for('main.accept_trade', request_id=context_trade_request.id) }}" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-success"><i class="fas fa-check me-2"></i>Accept & Chat</button>
                                </form>
                                <form action="{{ url_for('main.reject_trade', request_id=context_trade_request.id) }}" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-danger"><i class="fas fa-times me-2"></i>Reject</button>
                                </form>
                            </div>
                        {% elif current_user.user_id == item.user_id %}
                            <a href="{{ url_for('main.edit_item', item_id=item.item_id) }}" class="btn btn-warning"><i class="fas fa-edit me-2"></i>Edit</a>
                            <form action="{{ url_for('main.delete_item', item_id=item.item_id) }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure?');"><i class="fas fa-trash me-2"></i>Delete</button>
                            </form>
                        {% else %}
                            <form action="{{ url_for('main.add_or_remove_bookmark', item_id=item.item_id) }}" method="POST" class="d-inline">
                                {% if is_bookmarked %}<button type="submit" class="btn btn-primary"><i class="fas fa-bookmark me-2"></i>Bookmarked</button>
                                {% else %}<button type="submit" class="btn btn-outline-primary"><i class="far fa-bookmark me-2"></i>Bookmark</button>{% endif %}
                            </form>
                            {% if not item.deal_finalized_at %}
                                <div class="trade-action-wrapper d-inline-block">
                                    {% if item.type == 'Trade' %}
                                        {% if item.expected_return == 'Money' %}
                                            <a href="{{ url_for('main.request_trade', item_id=item.item_id) }}" class="btn btn-success"><i class="fas fa-dollar-sign me-2"></i>Make Offer</a>
                                        {% else %}
                                            {% if trade_request and trade_request.status == 'accepted' %}
                                                <a href="{{ url_for('main.chat', session_id=session.session_id) }}" class="btn btn-primary"><i class="fas fa-comments me-2"></i>Go to Chat</a>
                                            {% elif trade_request and trade_request.status == 'pending' %}
                                                <button class="btn btn-secondary" disabled><i class="fas fa-clock me-2"></i>Request Sent</button>
                                            {% else %}
                                                <a href="{{ url_for('main.request_trade', item_id=item.item_id) }}" class="btn btn-success"><i class="fas fa-exchange-alt me-2"></i>Request Trade</a>
                                            {% endif %}
                                        {% endif %}
                                    {% elif item.type == 'Share' %}
                                    {% endif %}
                                </div>
                            {% endif %}
                            <a href="{{ url_for('main.report_general', item_id=item.item_id) }}" class="btn btn-outline-danger"><i class="fas fa-flag me-2"></i>Report</a>
                        {% endif %}

                    {# --- Organization-Specific Actions --- #}
                    {% elif current_user.__class__.__name__ == 'Organization' %}
                        {# *** REMOVED Bookmark Button for Orgs *** #}
                        {# *** REMOVED CHAT ABOUT SHARING BUTTON FOR ORG *** #}

                        {# Report Button for Orgs (Kept) #}
                        <a href="{{ url_for('main.report_general', item_id=item.item_id) }}" class="btn btn-outline-danger"><i class="fas fa-flag me-2"></i>Report</a>

                    {% endif %} {# End check User vs Org #}
                {% else %}
                    {# --- Not Logged In --- #}
                    <a href="{{ url_for('main.login') }}" class="btn btn-primary">Login to interact</a>
                {% endif %} {# End check authenticated #}
                {# --- End Conditional Button Logic --- #}
            </div> {# End action-buttons #}

        </div> {# End col-lg-7 #}

        <div class="col-lg-5">
            <div class="d-flex flex-column gap-4">
                {# --- Sidebar Cards --- #}
                <div class="sidebar-card shadow-sm">
                    <h5 class="fw-bold mb-3">Posted By</h5>
                     <a href="{{ url_for('main.public_profile', user_id=item.owner.user_id) }}" class="owner-info text-decoration-none text-body">
                        <img src="{{ url_for('static', filename=item.owner.profile_picture or 'images/users_placeholder.png') }}" alt="{{ item.owner.first_name }}">
                        <div>
                            <h6 class="fw-bold mb-0">{{ item.owner.first_name }} {{ item.owner.last_name }}</h6>
                            <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>{{ item.owner.location }}</small>
                        </div>
                    </a>
                </div>


                <div class="sidebar-card shadow-sm">
                    <h5 class="fw-bold mb-3">Item Details</h5>
                    <ul class="details-list">
                        <li><span>Posted On</span> <strong>{{ item.created_at.strftime('%b %d, %Y') }}</strong></li>
                        <li><span>Status</span> <strong>{{ item.status }}</strong></li>
                        <li><span>Item Type</span> <strong>{{ item.type }}</strong></li>
                        <li><span>Location</span> <strong>{{ item.location or '—' }}</strong></li>
                        {% if item.type == 'Trade' %}
                            <li><span>Expected Return</span> <strong>{{ item.expected_return or '—' }}</strong></li>
                        {% endif %}
                    </ul>
                </div>
                {# --- End Sidebar Cards --- #}
            </div> {# End d-flex flex-column #}
        </div> {# End col-lg-5 #}
    </div> {# End row g-5 #}

    {# --- Incoming Trade Requests Section (Remains unchanged - Only for Users) --- #}
    {% if current_user.is_authenticated and current_user.__class__.__name__ == 'User' and current_user.user_id == item.user_id and item.type == 'Trade' %}
        <div class="row mt-5">
            <div class="col-12">
                <button class="btn btn-outline-primary mb-3 w-100 d-flex justify-content-between align-items-center"
                        type="button" data-bs-toggle="collapse" data-bs-target="#tradeRequestsCollapse"
                        aria-expanded="false" aria-controls="tradeRequestsCollapse">
                    <span>
                        <i class="fas fa-exchange-alt me-2"></i>
                        View Trade Requests
                        {% if incoming_trade_requests %}
                        <span class="badge bg-secondary rounded-pill ms-2">{{ incoming_trade_requests|length }}</span>
                        {% endif %}
                    </span>
                    {% if incoming_trade_requests %}
                        <span class="badge bg-danger rounded-pill">New</span>
                    {% endif %}
                </button>
                <div class="collapse" id="tradeRequestsCollapse">
                    {% if incoming_trade_requests %}
                    <div class="list-group">
                        {% for request in incoming_trade_requests %}
                        <div class="list-group-item list-group-item-action mb-2 border rounded">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">{{ request.requester.first_name }} wants to trade!</h5>
                                <small>{{ request.created_at.strftime('%Y-%m-%d') }}</small>
                            </div>
                            <div class="d-flex align-items-center my-2">
                                <img src="{{ url_for('static', filename=request.offered_item.images[0].image_url if request.offered_item.images else 'images/item_placeholder.jpg') }}"
                                    style="width: 80px; height: 80px; object-fit: cover; border-radius: 0.5rem; margin-right: 1rem;"
                                    alt="{{ request.offered_item.title }}">
                                <p class="mb-0">
                                    They are offering their item: <strong>{{ request.offered_item.title }}</strong>.
                                </p>
                            </div>
                            <div class="mt-2 d-flex gap-2">
                                <a href="{{ url_for('main.view_item', item_id=request.offered_item.item_id, context_trade_id=request.id) }}" class="btn btn-outline-secondary btn-sm">View Offered Item</a>
                                <form action="{{ url_for('main.accept_trade', request_id=request.id) }}" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-success btn-sm"><i class="fas fa-check me-1"></i> Accept & Chat</button>
                                </form>
                                <form action="{{ url_for('main.reject_trade', request_id=request.id) }}" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-times me-1"></i> Reject</button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                         <p class="text-muted text-center border rounded p-3"><i class="fas fa-info-circle me-2"></i>You have no pending trade requests for this item.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
    {# --- End Incoming Trade Requests Section --- #}

</div> {# End container #}

{# --- Lightbox for Main Image --- #}
<div class="lightbox" id="lightbox">
    <span class="lightbox-close" id="lightboxClose">&times;</span>
    <img class="lightbox-content" id="lightboxImage" src="">
</div>
{# --- End Lightbox --- #}

<script>
// --- JAVASCRIPT FOR COPYING CURRENT PAGE LINK ---
    function copyCurrentPageLink(buttonElement) {
        const urlToCopy = window.location.href; // Get current page URL
        const feedbackSpan = buttonElement.querySelector('.copy-feedback');
        navigator.clipboard.writeText(urlToCopy).then(() => {
            feedbackSpan.style.display = 'inline';
            buttonElement.disabled = true; // Disable button briefly
            setTimeout(() => {
                feedbackSpan.style.display = 'none';
                buttonElement.disabled = false;
            }, 1500); // Show feedback for 1.5 seconds
        }).catch(err => {
            console.error('Failed to copy link: ', err);
            alert('Could not copy link. Please try again.');
        });
    }
// --- END JAVASCRIPT FOR COPYING LINK ---

document.addEventListener('DOMContentLoaded', () => {
    // --- Gallery thumbnail switching logic ---
    const mainImage = document.getElementById('mainImage');
    const thumbnails = document.querySelectorAll('.thumbnail-item');
    thumbnails.forEach(thumb => {
        thumb.addEventListener('click', function() {
            mainImage.src = this.querySelector('img').src;
            thumbnails.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // --- Lightbox logic ---
    const mainImageViewer = document.getElementById('mainImageViewer');
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    const lightboxClose = document.getElementById('lightboxClose');

    mainImageViewer?.addEventListener('click', () => {
        if (mainImage && mainImage.src && !mainImage.src.includes('item_placeholder.jpg')) {
            lightboxImage.src = mainImage.src;
            lightbox.classList.add('visible');
        }
    });

    lightboxClose?.addEventListener('click', () => {
        lightbox.classList.remove('visible');
    });

    lightbox?.addEventListener('click', (e) => {
        if (e.target === lightbox) {
            lightbox.classList.remove('visible');
        }
    });
    // --- End Lightbox ---
});
</script>

{% endblock %}