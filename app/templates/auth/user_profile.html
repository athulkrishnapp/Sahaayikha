{% extends "base.html" %}
{% block content %}
<style>
    /* Profile Page Specific Styles */
    .profile-container {
        background-color: var(--bs-card-bg);
        border-radius: 1rem;
        border: 1px solid var(--bs-border-color);
    }
    .profile-sidebar {
        padding: 2rem;
        border-right: 1px solid var(--bs-border-color);
    }
    .dark-mode .profile-sidebar {
        border-right-color: var(--bs-border-color-translucent);
    }
    .profile-content {
        padding: 2rem;
    }
    @media (max-width: 992px) {
        .profile-sidebar {
            border-right: none;
            border-bottom: 1px solid var(--bs-border-color);
        }
        .dark-mode .profile-sidebar {
            border-bottom-color: var(--bs-border-color-translucent);
        }
    }
    .blocked-user-info { display: flex; align-items: center; gap: 0.75rem; }
    .blocked-user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    
    #passwordError {
        color: var(--bs-danger);
        font-size: 0.875em;
        margin-top: 0.5rem;
        display: none; /* Hidden by default */
    }
</style>

<div class="container my-5">
    {# Display flashed messages first #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-4">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="profile-container shadow-sm overflow-hidden">
        <div class="row g-0">
            <div class="col-lg-7 profile-sidebar">
                <h3 class="mb-4 fw-bold">My Profile</h3>
                <form method="POST" enctype="multipart/form-data" novalidate id="profileUpdateForm">
                    {{ form.hidden_tag() }}

                    {# --- Profile Picture Uploader Include --- #}
                    {% set form_field = form.profile_picture %}
                    {% set placeholder_img = 'images/users_placeholder.png' %}
                    {% set current_img = current_user.profile_picture %}
                    {% set delete_url = url_for('main.delete_profile_picture') %}
                    {% include 'auth/_profile_uploader.html' %}
                    {# --- End Profile Picture Uploader --- #}

                    {# --- Form Fields --- #}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.first_name.label(class="form-label") }}
                            {{ form.first_name(class="form-control" ~ (' is-invalid' if form.first_name.errors else ''), **{'data-initial-value': current_user.first_name or ''}) }}
                            {% for error in form.first_name.errors %}
                              <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.last_name.label(class="form-label") }}
                            {{ form.last_name(class="form-control" ~ (' is-invalid' if form.last_name.errors else ''), **{'data-initial-value': current_user.last_name or ''}) }}
                             {% for error in form.last_name.errors %}
                              <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mb-3">
                        {{ form.email.label(class="form-label") }}
                        {{ form.email(class="form-control") }} {# Email is disabled via route logic #}
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.phone.label(class="form-label") }}
                            {{ form.phone(class="form-control" ~ (' is-invalid' if form.phone.errors else ''), **{'data-initial-value': current_user.phone or ''}) }}
                             {% for error in form.phone.errors %}
                              <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.location.label(class="form-label") }}
                            {{ form.location(class="form-select" ~ (' is-invalid' if form.location.errors else '')) }}
                            {% for error in form.location.errors %}
                              <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>

                    {# *** REMOVED Optional New Password Fields Section *** #}
                    {# <hr>
                     <p class="text-muted small mb-3">Only fill the fields below if you want to change your password.</p>
                     <div class="row">
                         <div class="col-md-6 mb-3">
                             {{ form.password.label(class="form-label") }}
                             ...
                         </div>
                         <div class="col-md-6 mb-3">
                             {{ form.confirm_password.label(class="form-label") }}
                             ...
                         </div>
                     </div> #}
                    {# *** END REMOVAL *** #}

                    <div class="d-grid mt-3">
                        <button type="button" id="updateProfileBtn" class="btn btn-primary">Update Profile</button>
                    </div>
                    {# --- End Form Fields --- #}
                </form>
            </div>

            <div class="col-lg-5 profile-content">
                <h4 class="mb-4 fw-bold">Account Settings</h4>
                <div class="mb-4">
                    <h5 class="mb-3">Change Password</h5> {# Renamed slightly #}
                    <p class="text-muted small">Use the link below to request a password reset email.</p>
                    <a href="{{ url_for('main.logout', next=url_for('main.forgot_password')) }}" class="btn btn-outline-warning btn-sm">Send Password Reset Email</a> {# Made button smaller #}
                </div>
                <hr>
                <div class="mb-4">
                    <h5 class="mb-3">Blocked Users</h5>
                     {# ... Blocked users list ... #}
                    {% if blocked_chats %}
                        <ul class="list-group list-group-flush">
                            {% for chat in blocked_chats %}
                                {% set other_user = chat.user_two if chat.user_one_id == current_user.user_id else chat.user_one %}
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <div class="blocked-user-info">
                                        <img src="{{ url_for('static', filename=other_user.profile_picture or 'images/users_placeholder.png') }}" alt="{{ other_user.first_name }}" class="blocked-user-avatar">
                                        <div>
                                            <span>{{ other_user.first_name }} {{ other_user.last_name }}</span>
                                            <small class="d-block text-muted">Re: {{ chat.trade_item.title|truncate(20) if chat.trade_item else '[Deleted Item]'}}</small>
                                        </div>
                                    </div>
                                    <form action="{{ url_for('main.unblock_chat', session_id=chat.session_id) }}" method="POST">
                                        <button type="submit" class="btn btn-sm btn-outline-secondary">Unblock</button>
                                    </form>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">You have not blocked any users.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{# *** Password Confirmation Modal (Remains the same) *** #}
<div class="modal fade" id="passwordConfirmModal" tabindex="-1" aria-labelledby="passwordConfirmModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="passwordConfirmModalLabel">Confirm Changes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Please enter your current password to confirm changes to your name or phone number.</p>
        <div class="mb-3">
          <label for="modalCurrentPassword" class="form-label">Current Password</label>
          <input type="password" class="form-control" id="modalCurrentPassword" required>
          <div id="passwordError" class="mt-2"></div> {# Error message area #}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="modalConfirmBtn">Confirm & Update</button>
      </div>
    </div>
  </div>
</div>
{# *** END MODAL *** #}

{# *** JavaScript (Remains the same) *** #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const profileForm = document.getElementById('profileUpdateForm');
    const updateBtn = document.getElementById('updateProfileBtn');
    const passwordModalElement = document.getElementById('passwordConfirmModal');
    const passwordModal = new bootstrap.Modal(passwordModalElement);
    const modalPasswordField = document.getElementById('modalCurrentPassword');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    const passwordErrorDiv = document.getElementById('passwordError');

    // --- Store initial values ---
    const firstNameInput = profileForm.elements['first_name'];
    const lastNameInput = profileForm.elements['last_name'];
    const phoneInput = profileForm.elements['phone'];

    const initialFirstName = firstNameInput.dataset.initialValue || '';
    const initialLastName = lastNameInput.dataset.initialValue || '';
    const initialPhone = phoneInput.dataset.initialValue || '';

    // --- Function to check if sensitive fields changed ---
    function sensitiveFieldsChanged() {
        const currentFirstName = firstNameInput.value.trim();
        const currentLastName = lastNameInput.value.trim();
        const currentPhone = phoneInput.value.trim();

        // Normalize empty strings/null for comparison if needed
        const normInitialLastName = initialLastName === 'None' ? '' : initialLastName;
        const normInitialPhone = initialPhone === 'None' ? '' : initialPhone;

        return currentFirstName !== initialFirstName ||
               currentLastName !== normInitialLastName ||
               currentPhone !== normInitialPhone;
    }

    // --- Handle Update Button Click ---
    updateBtn.addEventListener('click', function(event) {
        // Clear previous modal errors
        passwordErrorDiv.style.display = 'none';
        passwordErrorDiv.textContent = '';
        modalPasswordField.classList.remove('is-invalid');
        modalPasswordField.value = ''; // Clear password field

        if (sensitiveFieldsChanged()) {
            // Show the modal if changes detected
            passwordModal.show();
        } else {
            // No sensitive changes, submit the form directly
            profileForm.submit();
        }
    });

    // --- Handle Modal Confirm Button Click ---
    modalConfirmBtn.addEventListener('click', function() {
        const enteredPassword = modalPasswordField.value;
        passwordErrorDiv.style.display = 'none'; // Hide error initially
        modalPasswordField.classList.remove('is-invalid');

        if (!enteredPassword) {
            passwordErrorDiv.textContent = 'Password cannot be empty.';
            passwordErrorDiv.style.display = 'block';
            modalPasswordField.classList.add('is-invalid');
            return;
        }

        // Disable button during verification
        modalConfirmBtn.disabled = true;
        modalConfirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Verifying...';

        // AJAX call to verify password
        fetch("{{ url_for('main.verify_profile_password') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': profileForm.elements['csrf_token'].value
            },
            body: JSON.stringify({ password: enteredPassword })
        })
        .then(response => {
             if (response.ok) { return response.json(); }
             return response.json().then(errData => { throw new Error(errData.error || `HTTP error! status: ${response.status}`); });
        })
        .then(data => {
            if (data.success) {
                // Password correct, submit the original form
                passwordModal.hide();
                profileForm.submit();
            } else {
                passwordErrorDiv.textContent = data.error || 'Verification failed.';
                passwordErrorDiv.style.display = 'block';
                modalPasswordField.classList.add('is-invalid');
            }
        })
        .catch(error => {
            console.error('Password verification error:', error);
            passwordErrorDiv.textContent = error.message || 'Incorrect password or server error.';
            passwordErrorDiv.style.display = 'block';
             modalPasswordField.classList.add('is-invalid');
        })
         .finally(() => {
             // Re-enable button
             modalConfirmBtn.disabled = false;
             modalConfirmBtn.innerHTML = 'Confirm & Update';
         });
    });

     // Optional: Clear error when modal is hidden
     passwordModalElement.addEventListener('hidden.bs.modal', function () {
         passwordErrorDiv.style.display = 'none';
         passwordErrorDiv.textContent = '';
         modalPasswordField.classList.remove('is-invalid');
         modalPasswordField.value = '';
     });

});
</script>
{# *** END JAVASCRIPT *** #}

{% endblock %}