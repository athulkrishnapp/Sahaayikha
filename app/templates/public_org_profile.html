{% extends "base.html" %}
{% block content %}

<style>
    /* --- Base Variables (Keep or Adjust) --- */
    :root {
        --primary: hsl(260, 84%, 60%);
        --primary-light: hsl(260, 84%, 95%);
        --primary-lighter: hsl(260, 84%, 98%); /* Added */
        --success: hsl(145, 63%, 49%);
        --success-light: hsl(145, 63%, 96%); /* Adjusted lightness */
        --warning: hsl(45, 100%, 51%);
        --warning-light: hsl(45, 100%, 97%); /* Adjusted lightness */
        --info: hsl(195, 53%, 60%); /* Adjusted info color */
        --info-light: hsl(195, 53%, 96%); /* Adjusted lightness */
        --secondary: hsl(240, 4.8%, 95.9%);
        --border: hsl(240, 5.9%, 90%);
        --card: hsl(0, 0%, 100%);
        --card-foreground: hsl(240, 10%, 3.9%);
        --muted-foreground: hsl(240, 3.8%, 46.1%);
        --radius: 0.75rem;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* Added */
    }
    .dark-mode {
        --primary: hsl(260, 84%, 70%);
        --primary-light: hsla(260, 84%, 70%, 0.1);
        --primary-lighter: hsla(260, 84%, 70%, 0.05); /* Added */
        --success: hsl(145, 63%, 59%);
        --success-light: hsla(145, 63%, 59%, 0.1); /* Adjusted alpha */
        --warning: hsl(45, 100%, 61%);
        --warning-light: hsla(45, 100%, 61%, 0.1); /* Adjusted alpha */
        --info: hsl(195, 53%, 70%); /* Adjusted info color */
        --info-light: hsla(195, 53%, 70%, 0.1); /* Adjusted alpha */
        --secondary: hsl(240, 3.7%, 15.9%);
        --border: hsl(240, 3.7%, 25%);
        --card: hsl(240, 3.7%, 15.9%);
        --card-foreground: hsl(0, 0%, 98%);
        --muted-foreground: hsl(240, 5%, 64.9%);
    }

    /* --- General Layout --- */
    .profile-grid {
        display: grid;
        grid-template-columns: 320px 1fr; /* Slightly wider sidebar */
        gap: 3rem; /* Increased gap */
        align-items: start;
    }
    @media (max-width: 992px) {
        .profile-grid { grid-template-columns: 1fr; gap: 2.5rem; }
    }

    /* --- Enhanced Sidebar --- */
    .org-sidebar {
        position: sticky;
        top: calc(56px + 2rem); /* More top space */
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background-color: var(--card);
        box-shadow: var(--shadow-md); /* Enhanced shadow */
        padding: 2rem; /* Increased padding */
        text-align: center;
    }
     @media (max-width: 992px) { .org-sidebar { position: static; } }
    .org-sidebar img {
        width: 110px; height: 110px; /* Slightly larger */
        border-radius: 50%; object-fit: cover;
        border: 4px solid var(--card); /* Border matches card bg */
        margin-bottom: 1.25rem;
        margin-top: -4rem; /* Pull avatar up slightly */
        box-shadow: var(--shadow-md); /* Shadow on avatar */
        background-color: var(--card); /* Ensure bg under transparent images */
    }
    .org-sidebar h3 {
        font-weight: 700; font-size: 1.6rem; color: var(--card-foreground);
        margin-bottom: 0.5rem; line-height: 1.3;
    }
    .org-sidebar .org-meta {
        display: flex; flex-direction: column; gap: 0.75rem; /* Increased gap */
        margin-top: 1.5rem; margin-bottom: 1.5rem; text-align: left;
    }
    .org-meta-item {
        display: flex; align-items: center; gap: 0.75rem; font-size: 0.9rem;
        color: var(--muted-foreground);
    }
    .org-meta-item i { color: var(--primary); width: 18px; text-align: center; }
    .org-sidebar .org-description {
        font-size: 0.875rem; color: var(--muted-foreground); line-height: 1.7;
        text-align: left; margin-top: 1.5rem; border-top: 1px solid var(--border);
        padding-top: 1.5rem;
    }
    .org-sidebar .card-footer {
         margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);
         font-size: 0.8rem; color: var(--muted-foreground);
    }

    /* --- Right Content Area --- */
    .profile-content h2 {
        font-weight: 700; font-size: 1.85rem; color: var(--card-foreground);
        margin-bottom: 2rem; /* Increased margin */
        border-bottom: 1px solid var(--border);
        padding-bottom: 1rem; /* Increased padding */
    }

    /* --- Stunning Statistics Grid --- */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* Slightly wider min */
        gap: 1.5rem; /* Increased gap */
        margin-bottom: 3.5rem; /* Increased margin */
    }
    .stat-card {
        background: linear-gradient(145deg, var(--card), hsl(0deg 0% 98%)); /* Subtle gradient */
        border: 1px solid var(--border); border-radius: var(--radius);
        padding: 1.5rem; text-align: center; box-shadow: var(--shadow-md);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .dark-mode .stat-card { background: linear-gradient(145deg, var(--card), hsl(240deg 4% 12%)); }
    .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }

    .stat-card-icon {
        font-size: 1.75rem; margin-bottom: 1rem; height: 35px;
        display: inline-block; /* Needed for transforms */
        transition: transform 0.3s ease;
    }
    .stat-card:hover .stat-card-icon { transform: scale(1.1); }
    .stat-card-value {
        font-size: 2.25rem; font-weight: 700; color: var(--card-foreground);
        line-height: 1.1; display: block; /* Ensure block */
    }
    .stat-card-label {
        font-size: 0.8rem; color: var(--muted-foreground); margin-top: 0.35rem;
        text-transform: uppercase; letter-spacing: 0.5px;
    }
    /* Specific Icon Colors (Keep as is) */
    .stat-card-icon.total-needs { color: var(--primary); }
    .stat-card-icon.active-needs { color: var(--success); }
    .stat-card-icon.completed-donations { color: var(--info); }
    .stat-card-icon.in-progress-offers { color: hsl(210, 50%, 60%); }
    .stat-card-icon.pending-offers { color: var(--warning); }


    /* --- Extraordinary Needs List --- */
    .needs-list .list-group-item {
        background-color: var(--card);
        border: 1px solid var(--border); border-left-width: 5px; /* Thicker border */
        margin-bottom: 1.25rem; /* Increased gap */
        border-radius: var(--radius); padding: 1.5rem; /* Increased padding */
        transition: box-shadow 0.2s ease, border-color 0.2s ease;
        box-shadow: var(--shadow-md); /* Start with medium shadow */
        position: relative; /* For stretched link */
        overflow: hidden; /* Ensure corners are rounded */
    }
     .needs-list .list-group-item:hover { box-shadow: var(--shadow-lg); } /* Larger shadow on hover */

    /* Status Styles with Subtle Backgrounds */
    .need-active { border-left-color: var(--success); background-color: var(--success-light); }
    .need-ended { border-left-color: var(--warning); background-color: var(--warning-light); }
    .need-other { border-left-color: var(--bs-secondary); background-color: var(--secondary); }

    .need-header {
        display: flex; justify-content: space-between; align-items: flex-start;
        margin-bottom: 0.75rem; /* Increased space */
    }
    .need-title {
        font-size: 1.25rem; font-weight: 700; /* Bolder */
        color: var(--card-foreground); margin-right: 1rem; margin-bottom: 0;
    }
    .need-title a { color: inherit; text-decoration: none; }
    .need-title a::after { /* Make entire card clickable for active needs */
        content: ""; position: absolute; top: 0; right: 0; bottom: 0; left: 0;
        z-index: 1; pointer-events: auto; background-color: rgba(0,0,0,0);
    }
    .need-title a:hover { color: var(--primary); }
    .need-ended .need-title { color: var(--muted-foreground); } /* Fade title for ended */

    .need-status-badge {
        font-size: 0.75rem; font-weight: 600; /* Slightly bolder */
        padding: 0.3em 0.8em; flex-shrink: 0; align-self: flex-start;
        text-transform: uppercase; letter-spacing: 0.5px;
    }
     .need-date {
        font-size: 0.8rem; color: var(--muted-foreground); margin-bottom: 1rem; /* More space */
     }

    .need-description {
        font-size: 0.95rem; /* Slightly larger */
        color: var(--muted-foreground); margin-bottom: 1.25rem; line-height: 1.7;
    }
    .need-categories-list {
        display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.25rem;
    }
    .need-category-badge {
        background-color: var(--primary-lighter); /* Use lighter primary */
        color: var(--primary); /* Use primary color */
        font-size: 0.75rem; padding: 0.3rem 0.7rem; border-radius: 50px;
        border: 1px solid transparent; /* Remove border or match bg */
        font-weight: 500;
    }
    .dark-mode .need-category-badge { background-color: var(--primary-light); color: var(--primary); }

    .need-stats {
        font-size: 0.875rem; /* Slightly larger */
        color: var(--muted-foreground); margin-top: 1.25rem; padding-top: 1.25rem;
        border-top: 1px solid var(--border); /* Solid border */
        display: flex; gap: 1.75rem; flex-wrap: wrap;
    }
     .need-stats span { display: inline-flex; align-items: center; gap: 0.5rem; }
     .need-stats i { color: var(--primary); font-size: 1rem; /* Slightly larger icons */ }
     .need-stats .completed-icon { color: var(--success); }

</style>

<div class="container py-5">
    <div class="profile-grid">
        <aside class="org-sidebar">
            <img src="{{ url_for('static', filename=organization.profile_picture or 'images/orgs_placeholder.png') }}" alt="{{ organization.name }}">
            <h3>{{ organization.name }}</h3>

            <div class="org-meta">
                <div class="org-meta-item">
                    <i class="fas fa-map-marker-alt fa-fw"></i>
                    <span>{{ organization.location }}</span>
                </div>
                {% if organization.phone %}
                <div class="org-meta-item">
                    <i class="fas fa-phone fa-fw"></i>
                    <span>{{ organization.phone }}</span>
                </div>
                {% endif %}
                {% if organization.email %}
                <div class="org-meta-item">
                    <i class="fas fa-envelope fa-fw"></i>
                    <span>{{ organization.email }}</span>
                </div>
                {% endif %}
            </div>

            {% if organization.description %}
            <div class="org-description">
                 <p class="mb-0">{{ organization.description }}</p>
            </div>
            {% endif %}

            <div class="card-footer">
                Joined: {{ organization.registered_at.strftime('%B %Y') }}
            </div>
        </aside>

        <section class="profile-content">

            <h2>Statistics Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-bullhorn fa-fw stat-card-icon total-needs"></i>
                    <span class="stat-card-value">{{ stats.total_needs }}</span>
                    <span class="stat-card-label">Needs Posted</span>
                </div>
                <div class="stat-card">
                    <i class="fas fa-lightbulb fa-fw stat-card-icon active-needs"></i>
                    <span class="stat-card-value">{{ stats.active_needs }}</span>
                    <span class="stat-card-label">Active Needs</span>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle fa-fw stat-card-icon completed-donations"></i>
                    <span class="stat-card-value">{{ stats.completed_donations }}</span>
                    <span class="stat-card-label">Donations Completed</span>
                </div>
                <div class="stat-card">
                    <i class="fas fa-spinner fa-fw stat-card-icon in-progress-offers"></i>
                    <span class="stat-card-value">{{ stats.in_progress_offers }}</span>
                    <span class="stat-card-label">Offers In Progress</span>
                </div>
                <div class="stat-card">
                    <i class="fas fa-hourglass-half fa-fw stat-card-icon pending-offers"></i>
                    <span class="stat-card-value">{{ stats.pending_offers }}</span>
                    <span class="stat-card-label">Pending Offers</span>
                </div>
            </div>

            <h2>All Posted Needs</h2>
            {% if needs_data %}
                <div class="list-group needs-list">
                    {% for data_item in needs_data %}
                        {% set need = data_item.need %}
                        {% set offers_count = data_item.offers_received %}
                        {% set completed_count = data_item.donations_completed %}

                        {# Determine CSS class and Status Badge #}
                        {% set item_class = '' %}
                        {% set status_badge_class = '' %}
                        {% set status_text = '' %}

                        {% if need.status == 'Active' %}
                            {% set item_class = 'need-active' %}
                            {% set status_badge_class = 'bg-success' %}
                            {% set status_text = 'Active' %}
                        {% elif need.status == 'Deleted' %}
                            {% set item_class = 'need-ended' %}
                            {% set status_badge_class = 'bg-warning text-dark' %}
                            {% set status_text = 'Ended' %}
                        {% else %}
                            {% set item_class = 'need-other' %}
                            {% set status_badge_class = 'bg-secondary' %}
                            {% set status_text = need.status %}
                        {% endif %}

                        {# Render the list item #}
                        <div class="list-group-item {{ item_class }}">
                            <div class="need-header">
                                <h4 class="need-title">
                                     {# Link only if active #}
                                     {% if need.status == 'Active' %}
                                        <a href="{{ url_for('main.make_donation_offer', need_id=need.need_id) }}" class="stretched-link">
                                            {{ need.title }}
                                        </a>
                                     {% else %}
                                        {{ need.title }}
                                     {% endif %}
                                </h4>
                                <span class="badge rounded-pill need-status-badge {{ status_badge_class }}">{{ status_text }}</span>
                            </div>
                            <div class="need-date">
                                Posted: {{ (need.posted_at|localdatetime).strftime('%b %d, %Y, %I:%M %p') }} </div>

                            <p class="need-description">{{ need.description|truncate(200) }}</p> {% if need.categories %}
                                <div class="need-categories-list">
                                    {% for cat in need.categories.split(',') %}
                                        <span class="need-category-badge">{{ cat }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}

                            {# Need Stats #}
                            <div class="need-stats">
                                <span><i class="fas fa-box-heart fa-fw"></i> Offers: <strong>{{ offers_count }}</strong></span>
                                <span><i class="fas fa-check-circle fa-fw completed-icon"></i> Completed: <strong>{{ completed_count }}</strong></span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-muted border rounded p-5 mt-4"> <i class="fas fa-bullhorn fs-2 mb-3"></i> <h4>No Needs Posted Yet</h4>
                    <p>{{ organization.name }} hasn't posted any disaster needs at this time.</p>
                </div>
            {% endif %}

        </section>
    </div>
</div>
{% endblock %}